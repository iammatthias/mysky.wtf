---
import Layout from "../../layouts/Layout.astro";
import TopNav from "../../components/TopNav.astro";
import Footer from "../../components/Footer.astro";

const sessionCookie = Astro.cookies.get("ms_session");
let user = null;

if (sessionCookie) {
    try {
        user = JSON.parse(sessionCookie.value);
    } catch {
        // Invalid cookie
    }
}

if (!user) {
    return Astro.redirect("/login");
}
---

<Layout title="My Blog">
    <TopNav user={user} />

    <div class="ms-container">
        <div class="ms-profile">
            <div class="ms-profile-left">
                <div class="ms-box">
                    <div class="ms-box-header">Blog Controls</div>
                    <div class="ms-actions">
                        <a
                            href="/blog/new"
                            class="ms-action-btn ms-action-btn-primary"
                            >Post New Entry</a
                        >
                        <a href="/blog/drafts" class="ms-action-btn"
                            >My Drafts</a
                        >
                        <a href="/blog/settings" class="ms-action-btn"
                            >Blog Settings</a
                        >
                    </div>
                </div>

                <div class="ms-box">
                    <div class="ms-box-header ms-box-header-blue">
                        Blog Stats
                    </div>
                    <div class="ms-box-content">
                        <table class="ms-contact-table">
                            <tr>
                                <td>Published:</td>
                                <td id="published-count">0</td>
                            </tr>
                            <tr>
                                <td>Drafts:</td>
                                <td id="draft-count">0</td>
                            </tr>
                        </table>
                    </div>
                </div>

                <div class="ms-box">
                    <div class="ms-box-header">standard.site</div>
                    <div class="ms-box-content">
                        <p class="ms-text-small ms-text-gray">
                            Your blog uses the <a
                                href="https://standard.site"
                                target="_blank">standard.site</a
                            > format. Posts are portable across the AT Protocol network!
                        </p>
                    </div>
                </div>
            </div>

            <div class="ms-profile-right">
                <div class="ms-box">
                    <div class="ms-box-header">
                        {user.displayName || user.handle}'s Blog
                    </div>
                    <div class="ms-box-content" id="blog-list">
                        <div class="ms-loading">
                            <div class="ms-spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <Footer />
</Layout>

<script>
    import { Agent } from "@atproto/api";
    import { getSession } from "../../lib/auth";
    import {
        getDocuments,
        deleteDocument,
        getRkeyFromUri,
    } from "../../lib/atproto";

    // Simple markdown to HTML for display
    function markdownToHtml(text: string): string {
        return text
            .replace(/^### (.*$)/gim, "<h3>$1</h3>")
            .replace(/^## (.*$)/gim, "<h2>$1</h2>")
            .replace(/^# (.*$)/gim, "<h1>$1</h1>")
            .replace(/\*\*(.*)\*\*/gim, "<strong>$1</strong>")
            .replace(/\*(.*)\*/gim, "<em>$1</em>")
            .replace(/\[([^\]]+)\]\(([^)]+)\)/gim, '<a href="$2">$1</a>')
            .replace(/^- (.*$)/gim, "<li>$1</li>")
            .replace(/\n/g, "<br>");
    }

    async function loadBlog() {
        const session = await getSession();
        if (!session) {
            window.location.href = "/login";
            return;
        }

        const agent = new Agent(session);

        try {
            const documents = await getDocuments(agent, session.did, 50);
            const blogList = document.getElementById("blog-list")!;
            const publishedCount = document.getElementById("published-count")!;
            const draftCount = document.getElementById("draft-count")!;

            const published = documents.filter(
                (d) => d.value.visibility !== "draft",
            );
            const drafts = documents.filter(
                (d) => d.value.visibility === "draft",
            );

            publishedCount.textContent = published.length.toString();
            draftCount.textContent = drafts.length.toString();

            if (published.length === 0) {
                blogList.innerHTML = `
          <div style="text-align: center; padding: 40px;">
            <p class="ms-text-gray" style="margin-bottom: 15px;">You haven't published any blog entries yet!</p>
            <a href="/blog/new" class="ms-action-btn ms-action-btn-primary">Write Your First Entry</a>
          </div>
        `;
                return;
            }

            // Sort by publishedAt descending
            published.sort(
                (a, b) =>
                    new Date(b.value.publishedAt).getTime() -
                    new Date(a.value.publishedAt).getTime(),
            );

            blogList.innerHTML = published
                .map((doc) => {
                    const rkey = getRkeyFromUri(doc.uri);
                    const content =
                        doc.value.content?.value || doc.value.textContent || "";
                    const tags =
                        doc.value.tags
                            ?.map((t) => `<span class="tag">${t}</span>`)
                            .join(" ") || "";
                    const visibility =
                        doc.value.visibility === "friends"
                            ? '<span class="visibility-badge">Friends Only</span>'
                            : "";

                    return `
          <div class="ms-blog-entry" data-rkey="${rkey}">
            <h3 class="ms-blog-title">
              <a href="/blog/entry/${rkey}">${doc.value.title}</a>
              ${visibility}
            </h3>
            ${doc.value.description ? `<p class="ms-blog-description">${doc.value.description}</p>` : ""}
            <p class="ms-blog-meta">
              Published: ${new Date(doc.value.publishedAt).toLocaleDateString()} at ${new Date(doc.value.publishedAt).toLocaleTimeString()}
              ${doc.value.updatedAt ? `| Updated: ${new Date(doc.value.updatedAt).toLocaleDateString()}` : ""}
            </p>
            ${tags ? `<p class="ms-blog-tags">${tags}</p>` : ""}
            <div class="ms-blog-content">
              ${markdownToHtml(content.substring(0, 500))}${content.length > 500 ? "..." : ""}
            </div>
            <p style="margin-top: 10px;">
              <a href="/blog/edit/${rkey}" class="ms-text-small">Edit</a>
              <span class="ms-text-gray"> | </span>
              <a href="#" class="ms-text-small ms-text-orange delete-btn" data-rkey="${rkey}">Delete</a>
            </p>
          </div>
        `;
                })
                .join("");

            // Add delete handlers
            document.querySelectorAll(".delete-btn").forEach((btn) => {
                btn.addEventListener("click", async (e) => {
                    e.preventDefault();
                    const rkey = (btn as HTMLElement).dataset.rkey;
                    if (!rkey) return;

                    if (
                        !confirm(
                            "Are you sure you want to delete this post? This cannot be undone.",
                        )
                    ) {
                        return;
                    }

                    try {
                        await deleteDocument(agent, rkey);
                        const entry = document.querySelector(
                            `.ms-blog-entry[data-rkey="${rkey}"]`,
                        );
                        if (entry) entry.remove();

                        // Update count
                        const current = parseInt(
                            publishedCount.textContent || "0",
                        );
                        publishedCount.textContent = (current - 1).toString();

                        // Show empty state if no posts left
                        if (current - 1 === 0) {
                            blogList.innerHTML = `
                <div style="text-align: center; padding: 40px;">
                  <p class="ms-text-gray" style="margin-bottom: 15px;">You haven't published any blog entries yet!</p>
                  <a href="/blog/new" class="ms-action-btn ms-action-btn-primary">Write Your First Entry</a>
                </div>
              `;
                        }
                    } catch (error) {
                        console.error("Failed to delete post:", error);
                        alert("Failed to delete post. Please try again.");
                    }
                });
            });
        } catch (error) {
            console.error("Failed to load blog:", error);
            document.getElementById("blog-list")!.innerHTML = `
        <p class="ms-text-gray" style="padding: 20px; text-align: center;">
          Failed to load blog entries. <a href="/blog">Try again</a>
        </p>
      `;
        }
    }

    loadBlog();
</script>

<style>
    .ms-blog-description {
        font-size: 12px;
        color: #666;
        font-style: italic;
        margin: 5px 0;
    }

    .ms-blog-tags {
        margin: 8px 0;
    }

    .ms-blog-tags .tag {
        display: inline-block;
        padding: 2px 8px;
        background: var(--ms-blue-light);
        color: var(--ms-navy);
        font-size: 10px;
        border-radius: 10px;
        margin-right: 5px;
    }

    .visibility-badge {
        font-size: 10px;
        padding: 2px 6px;
        background: #ffeeba;
        color: #856404;
        border-radius: 3px;
        margin-left: 8px;
        font-weight: normal;
    }
</style>

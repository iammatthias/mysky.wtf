---
import Layout from "../../layouts/Layout.astro";
import TopNav from "../../components/TopNav.astro";
import Footer from "../../components/Footer.astro";

const sessionCookie = Astro.cookies.get("ms_session");
let user = null;
if (sessionCookie) {
    try {
        user = JSON.parse(sessionCookie.value);
    } catch {}
}

if (!user) {
    return Astro.redirect("/login?redirect=/blog/settings");
}
---

<Layout title="Blog Settings">
    <TopNav user={user} />
    <div class="ms-container">
        <div class="ms-profile">
            <div class="ms-profile-left">
                <div class="ms-box">
                    <div class="ms-box-header">Blog Controls</div>
                    <div class="ms-actions">
                        <a
                            href="/blog/new"
                            class="ms-action-btn ms-action-btn-primary"
                            >Post New Entry</a
                        >
                        <a href="/blog/drafts" class="ms-action-btn"
                            >My Drafts</a
                        >
                        <a
                            href="/blog/settings"
                            class="ms-action-btn ms-action-btn-active"
                            >Blog Settings</a
                        >
                    </div>
                </div>

                <div class="ms-box">
                    <div class="ms-box-header ms-box-header-blue">
                        Quick Links
                    </div>
                    <div class="ms-actions">
                        <a href="/blog" class="ms-action-btn">View My Blog</a>
                        <a
                            href={`/profile/${user.handle}/blog`}
                            class="ms-action-btn">Public Blog Page</a
                        >
                    </div>
                </div>
            </div>

            <div class="ms-profile-right">
                <div class="ms-box">
                    <div class="ms-box-header">
                        Publication Settings (standard.site)
                    </div>
                    <div class="ms-box-content">
                        <p
                            class="ms-text-small ms-text-gray"
                            style="margin-bottom: 15px;"
                        >
                            Configure your <a
                                href="https://standard.site"
                                target="_blank">standard.site</a
                            > publication. These settings define how your blog appears
                            across the AT Protocol network.
                        </p>

                        <form id="publication-form" class="ms-form">
                            <div class="ms-section-header">
                                Publication Info
                            </div>

                            <div class="ms-form-group">
                                <label class="ms-form-label" for="pub-name"
                                    >Publication Name:</label
                                >
                                <input
                                    type="text"
                                    id="pub-name"
                                    name="name"
                                    class="ms-form-input"
                                    placeholder="My Awesome Blog"
                                    maxlength="128"
                                    required
                                />
                                <p
                                    class="ms-text-small ms-text-gray"
                                    style="margin-top: 2px;"
                                >
                                    The name of your blog (max 128 characters)
                                </p>
                            </div>

                            <div class="ms-form-group">
                                <label
                                    class="ms-form-label"
                                    for="pub-description">Description:</label
                                >
                                <textarea
                                    id="pub-description"
                                    name="description"
                                    class="ms-form-textarea"
                                    placeholder="A brief description of what your blog is about..."
                                    maxlength="300"
                                    style="min-height: 80px;"></textarea>
                                <p
                                    class="ms-text-small ms-text-gray"
                                    style="margin-top: 2px;"
                                >
                                    Brief description (max 300 characters)
                                </p>
                            </div>

                            <div class="ms-form-group">
                                <label class="ms-form-label" for="pub-icon"
                                    >Publication Icon:</label
                                >
                                <div class="icon-upload-area">
                                    <img
                                        id="current-icon"
                                        src="/default-avatar.svg"
                                        alt="Current icon"
                                        class="pub-icon-preview"
                                    />
                                    <div class="icon-controls">
                                        <input
                                            type="file"
                                            id="pub-icon"
                                            name="icon"
                                            accept="image/*"
                                            class="ms-form-input"
                                        />
                                        <p
                                            class="ms-text-small ms-text-gray"
                                            style="margin-top: 4px;"
                                        >
                                            Square image, at least 256x256, max
                                            1MB
                                        </p>
                                    </div>
                                </div>
                            </div>

                            <div
                                class="ms-section-header"
                                style="margin-top: 25px;"
                            >
                                Theme Colors
                            </div>
                            <p
                                class="ms-text-small ms-text-gray"
                                style="margin-bottom: 15px;"
                            >
                                These colors will be used by AT Protocol readers
                                when displaying your content.
                            </p>

                            <div class="color-grid">
                                <div class="ms-form-group">
                                    <label class="ms-form-label" for="color-bg"
                                        >Background:</label
                                    >
                                    <input
                                        type="color"
                                        id="color-bg"
                                        name="colorBg"
                                        value="#ffffff"
                                        class="color-input"
                                    />
                                </div>
                                <div class="ms-form-group">
                                    <label class="ms-form-label" for="color-fg"
                                        >Text:</label
                                    >
                                    <input
                                        type="color"
                                        id="color-fg"
                                        name="colorFg"
                                        value="#003366"
                                        class="color-input"
                                    />
                                </div>
                                <div class="ms-form-group">
                                    <label
                                        class="ms-form-label"
                                        for="color-accent">Accent:</label
                                    >
                                    <input
                                        type="color"
                                        id="color-accent"
                                        name="colorAccent"
                                        value="#ff6600"
                                        class="color-input"
                                    />
                                </div>
                                <div class="ms-form-group">
                                    <label
                                        class="ms-form-label"
                                        for="color-accent-fg"
                                        >Button Text:</label
                                    >
                                    <input
                                        type="color"
                                        id="color-accent-fg"
                                        name="colorAccentFg"
                                        value="#ffffff"
                                        class="color-input"
                                    />
                                </div>
                            </div>

                            <div
                                class="ms-section-header"
                                style="margin-top: 25px;"
                            >
                                Discovery
                            </div>

                            <div class="settings-checkbox">
                                <label>
                                    <input
                                        type="checkbox"
                                        name="showInDiscover"
                                        id="show-in-discover"
                                        checked
                                    />
                                    Show in discovery feeds
                                </label>
                                <p
                                    class="ms-text-small ms-text-gray"
                                    style="margin-left: 24px; margin-top: 4px;"
                                >
                                    Allow your publication to appear in AT
                                    Protocol discovery feeds
                                </p>
                            </div>

                            <div
                                class="ms-section-header"
                                style="margin-top: 25px;"
                            >
                                Default Post Settings
                            </div>

                            <div class="ms-form-group">
                                <label class="ms-form-label"
                                    >Default Visibility:</label
                                >
                                <div class="radio-group">
                                    <label class="radio-option">
                                        <input
                                            type="radio"
                                            name="defaultVisibility"
                                            value="public"
                                            checked
                                        />
                                        <span>Public - Anyone can read</span>
                                    </label>
                                    <label class="radio-option">
                                        <input
                                            type="radio"
                                            name="defaultVisibility"
                                            value="friends"
                                        />
                                        <span
                                            >Friends Only - Only followers can
                                            read</span
                                        >
                                    </label>
                                    <label class="radio-option">
                                        <input
                                            type="radio"
                                            name="defaultVisibility"
                                            value="draft"
                                        />
                                        <span
                                            >Draft - Save as draft by default</span
                                        >
                                    </label>
                                </div>
                            </div>

                            <div class="info-box">
                                <strong>About standard.site:</strong> Your publication
                                and documents are stored using the standard.site lexicon
                                format. This means your blog is portable - it can
                                be read by any AT Protocol compatible reader, not
                                just MySky!
                            </div>

                            <div class="form-actions">
                                <a href="/blog" class="ms-button-secondary"
                                    >‚Üê Back to Blog</a
                                >
                                <button
                                    type="submit"
                                    class="ms-button"
                                    id="save-btn">Save Publication</button
                                >
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <Footer />
</Layout>

<style>
    .ms-action-btn-active {
        background: var(--ms-orange) !important;
        color: white !important;
        border-color: #d45500 !important;
    }

    .icon-upload-area {
        display: flex;
        gap: 15px;
        align-items: flex-start;
    }

    .pub-icon-preview {
        width: 80px;
        height: 80px;
        border-radius: 8px;
        object-fit: cover;
        border: 2px solid #ddd;
    }

    .icon-controls {
        flex: 1;
    }

    .color-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
        gap: 15px;
    }

    .color-input {
        width: 100%;
        height: 40px;
        border: 1px solid #ddd;
        border-radius: 4px;
        cursor: pointer;
    }

    .settings-checkbox {
        margin-bottom: 10px;
    }

    .settings-checkbox label {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: var(--ms-navy);
        cursor: pointer;
    }

    .radio-group {
        display: flex;
        flex-direction: column;
        gap: 8px;
    }

    .radio-option {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 12px;
        color: var(--ms-navy);
        cursor: pointer;
        padding: 10px 12px;
        background: #f9f9f9;
        border-radius: 4px;
        border: 1px solid #ddd;
    }

    .radio-option:hover {
        background: #f0f0f0;
        border-color: var(--ms-orange);
    }

    .info-box {
        margin-top: 25px;
        padding: 15px;
        background: var(--ms-blue-light);
        border-radius: 4px;
        font-size: 11px;
        line-height: 1.6;
        color: var(--ms-navy);
    }

    .form-actions {
        display: flex;
        justify-content: space-between;
        margin-top: 25px;
        padding-top: 20px;
        border-top: 1px solid #ddd;
    }

    .ms-button {
        display: inline-block;
        padding: 8px 20px;
        background: var(--ms-orange);
        color: white;
        text-decoration: none;
        border-radius: 4px;
        font-size: 12px;
        border: 1px solid #d45500;
        cursor: pointer;
    }

    .ms-button-secondary {
        display: inline-block;
        padding: 8px 20px;
        background: white;
        color: var(--ms-navy);
        text-decoration: none;
        border-radius: 4px;
        font-size: 12px;
        border: 1px solid #ccc;
    }

    .ms-button:hover,
    .ms-button-secondary:hover {
        opacity: 0.9;
    }
</style>

<script>
    import { Agent } from "@atproto/api";
    import { getSession } from "../../lib/auth";
    import {
        getPublication,
        savePublication,
        uploadImage,
        getMySpaceProfile,
        saveMySpaceProfile,
        MYSKY_URL,
    } from "../../lib/atproto";
    import { rgb } from "../../lib/lexicons";
    import type { Publication, ThemeColorRGB } from "../../lib/lexicons";

    // Convert hex to RGB
    function hexToRgb(hex: string): ThemeColorRGB {
        const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
        if (result) {
            return rgb(
                parseInt(result[1], 16),
                parseInt(result[2], 16),
                parseInt(result[3], 16),
            );
        }
        return rgb(255, 255, 255);
    }

    // Convert RGB to hex
    function rgbToHex(color: ThemeColorRGB): string {
        return (
            "#" +
            [color.r, color.g, color.b]
                .map((x) => {
                    const hex = x.toString(16);
                    return hex.length === 1 ? "0" + hex : hex;
                })
                .join("")
        );
    }

    async function loadSettings() {
        const session = await getSession();
        if (!session) {
            window.location.href = "/login";
            return;
        }

        const agent = new Agent(session);

        try {
            // Load publication settings
            const publication = await getPublication(agent, session.did);

            if (publication) {
                (
                    document.getElementById("pub-name") as HTMLInputElement
                ).value = publication.name || "";
                (
                    document.getElementById(
                        "pub-description",
                    ) as HTMLTextAreaElement
                ).value = publication.description || "";

                if (publication.basicTheme) {
                    (
                        document.getElementById("color-bg") as HTMLInputElement
                    ).value = rgbToHex(publication.basicTheme.background);
                    (
                        document.getElementById("color-fg") as HTMLInputElement
                    ).value = rgbToHex(publication.basicTheme.foreground);
                    (
                        document.getElementById(
                            "color-accent",
                        ) as HTMLInputElement
                    ).value = rgbToHex(publication.basicTheme.accent);
                    (
                        document.getElementById(
                            "color-accent-fg",
                        ) as HTMLInputElement
                    ).value = rgbToHex(publication.basicTheme.accentForeground);
                }

                if (publication.preferences) {
                    (
                        document.getElementById(
                            "show-in-discover",
                        ) as HTMLInputElement
                    ).checked =
                        publication.preferences.showInDiscover !== false;
                }
            } else {
                // Set defaults based on user profile
                const profile = await agent.getProfile({ actor: session.did });
                (
                    document.getElementById("pub-name") as HTMLInputElement
                ).value =
                    `${profile.data.displayName || profile.data.handle}'s Blog`;
            }

            // Load MySky-specific settings
            const myspaceProfile = await getMySpaceProfile(agent, session.did);
            if (myspaceProfile?.blogSettings?.defaultVisibility) {
                const radio = document.querySelector(
                    `input[name="defaultVisibility"][value="${myspaceProfile.blogSettings.defaultVisibility}"]`,
                ) as HTMLInputElement;
                if (radio) radio.checked = true;
            }
        } catch (e) {
            console.error("Failed to load settings:", e);
        }
    }

    loadSettings();

    // Preview icon when selected
    const iconInput = document.getElementById("pub-icon") as HTMLInputElement;
    const iconPreview = document.getElementById(
        "current-icon",
    ) as HTMLImageElement;

    iconInput.addEventListener("change", () => {
        if (iconInput.files && iconInput.files[0]) {
            const reader = new FileReader();
            reader.onload = (e) => {
                iconPreview.src = e.target?.result as string;
            };
            reader.readAsDataURL(iconInput.files[0]);
        }
    });

    const form = document.getElementById("publication-form") as HTMLFormElement;
    const saveBtn = document.getElementById("save-btn") as HTMLButtonElement;

    form.addEventListener("submit", async (e) => {
        e.preventDefault();

        saveBtn.disabled = true;
        saveBtn.textContent = "Saving...";

        try {
            const session = await getSession();
            if (!session) {
                window.location.href = "/login";
                return;
            }

            const agent = new Agent(session);
            const profile = await agent.getProfile({ actor: session.did });

            // Get form values
            const name = (
                document.getElementById("pub-name") as HTMLInputElement
            ).value.trim();
            const description = (
                document.getElementById(
                    "pub-description",
                ) as HTMLTextAreaElement
            ).value.trim();
            const showInDiscover = (
                document.getElementById("show-in-discover") as HTMLInputElement
            ).checked;
            const defaultVisibility = (
                document.querySelector(
                    'input[name="defaultVisibility"]:checked',
                ) as HTMLInputElement
            )?.value;

            // Get theme colors
            const colorBg = (
                document.getElementById("color-bg") as HTMLInputElement
            ).value;
            const colorFg = (
                document.getElementById("color-fg") as HTMLInputElement
            ).value;
            const colorAccent = (
                document.getElementById("color-accent") as HTMLInputElement
            ).value;
            const colorAccentFg = (
                document.getElementById("color-accent-fg") as HTMLInputElement
            ).value;

            // Upload icon if provided
            let icon;
            if (iconInput.files && iconInput.files[0]) {
                const file = iconInput.files[0];
                if (file.size > 1000000) {
                    alert("Icon must be less than 1MB");
                    saveBtn.disabled = false;
                    saveBtn.textContent = "Save Publication";
                    return;
                }
                icon = await uploadImage(agent, file);
            }

            // Build publication record
            const publicationData: Omit<Publication, "$type"> = {
                url: `${MYSKY_URL}/profile/${profile.data.handle}/blog`,
                name,
                description: description || undefined,
                icon,
                basicTheme: {
                    background: hexToRgb(colorBg),
                    foreground: hexToRgb(colorFg),
                    accent: hexToRgb(colorAccent),
                    accentForeground: hexToRgb(colorAccentFg),
                },
                preferences: {
                    showInDiscover,
                },
            };

            await savePublication(agent, publicationData);

            // Also save default visibility to MySky profile
            const existingProfile =
                (await getMySpaceProfile(agent, session.did)) || {};
            await saveMySpaceProfile(agent, {
                ...existingProfile,
                blogSettings: {
                    ...existingProfile.blogSettings,
                    defaultVisibility: defaultVisibility as
                        | "public"
                        | "friends"
                        | "draft",
                },
            });

            alert("Publication settings saved!");
            saveBtn.textContent = "Saved!";

            setTimeout(() => {
                saveBtn.disabled = false;
                saveBtn.textContent = "Save Publication";
            }, 2000);
        } catch (error) {
            console.error("Failed to save settings:", error);
            alert("Failed to save settings. Please try again.");
            saveBtn.disabled = false;
            saveBtn.textContent = "Save Publication";
        }
    });
</script>

---
import Layout from '../layouts/Layout.astro';
import TopNav from '../components/TopNav.astro';
import Footer from '../components/Footer.astro';

// Check for session cookie (set by OAuth callback)
const sessionCookie = Astro.cookies.get('ms_session');
let user = null;

if (sessionCookie) {
  try {
    user = JSON.parse(sessionCookie.value);
  } catch {
    // Invalid cookie
  }
}
---

<Layout title="A Place for Friends">
  <TopNav user={user} />

  <div class="ms-container">
    {user ? (
      <!-- Logged in home page -->
      <div class="ms-profile">
        <div class="ms-profile-left">
          <div class="ms-box">
            <div class="ms-box-header">Welcome Back!</div>
            <div class="ms-box-content">
              <img
                src={user.avatar || '/default-avatar.svg'}
                alt={user.displayName || user.handle}
                class="ms-profile-pic"
              />
              <p class="ms-profile-name">{user.displayName || user.handle}</p>
              <p class="ms-profile-tagline">@{user.handle}</p>
              <div class="ms-actions ms-mt-10">
                <a href={`/profile/${user.handle}`} class="ms-action-btn ms-action-btn-primary">View My Profile</a>
                <a href="/edit" class="ms-action-btn">Edit Profile</a>
                <a href="/blog/new" class="ms-action-btn">Post New Blog</a>
              </div>
            </div>
          </div>

          <div class="ms-box">
            <div class="ms-box-header ms-box-header-blue">Quick Links</div>
            <div class="ms-actions">
              <a href="/browse" class="ms-action-btn">Browse Users</a>
              <a href="/search" class="ms-action-btn">Find Friends</a>
              <a href="/messages" class="ms-action-btn">Messages</a>
              <a href="/settings" class="ms-action-btn">Account Settings</a>
            </div>
          </div>
        </div>

        <div class="ms-profile-right">
          <div class="ms-box">
            <div class="ms-box-header">Bulletins</div>
            <div class="ms-box-content" id="bulletins-preview">
              <p class="ms-text-gray ms-text-small">Loading bulletins...</p>
            </div>
            <div style="padding: 8px; text-align: right; border-top: 1px solid #ccc;">
              <a href="/bulletins" class="ms-text-small">View All Bulletins</a>
            </div>
          </div>

          <div class="ms-box">
            <div class="ms-box-header ms-box-header-blue">My Friend Space</div>
            <div class="ms-box-content" id="friend-space">
              <p class="ms-text-gray ms-text-small">Loading your friends...</p>
            </div>
          </div>

          <div class="ms-box">
            <div class="ms-box-header">Cool New People</div>
            <div class="ms-box-content" id="cool-people">
              <p class="ms-text-gray ms-text-small">Discover new friends on the network!</p>
            </div>
          </div>

          <div class="ms-ad">
            <div class="ms-ad-label">ADVERTISEMENT</div>
            <p>ðŸŽ¸ Get your FREE MySky music player!</p>
            <p class="ms-text-small">Customize your profile with your favorite tunes</p>
          </div>
        </div>
      </div>
    ) : (
      <!-- Logged out landing page -->
      <div class="ms-login-page" style="min-height: auto; padding: 60px 20px; margin: -10px; width: calc(100% + 20px);">
        <h1 class="ms-login-logo">My<span>Sky</span></h1>
        <p class="ms-login-tagline">a place for friends</p>

        <div class="ms-login-box">
          <h2 class="ms-login-title">Member Login</h2>

          <form class="ms-form" id="login-form">
            <div class="ms-form-group">
              <label class="ms-form-label" for="handle">Bluesky Handle or DID:</label>
              <input
                type="text"
                id="handle"
                name="handle"
                class="ms-form-input"
                placeholder="yourname.bsky.social"
                required
              />
            </div>

            <button type="submit" class="ms-form-submit" style="width: 100%;">
              Sign In with AT Protocol
            </button>
          </form>

          <div class="ms-login-footer">
            <p>Don't have a Bluesky account?</p>
            <p><a href="https://bsky.app" target="_blank">Sign up at bsky.app</a></p>
          </div>
        </div>

        <div style="max-width: 600px; margin-top: 30px; text-align: center;">
          <div class="ms-box">
            <div class="ms-box-header">What is MySky?</div>
            <div class="ms-box-content">
              <p style="font-size: 12px; line-height: 1.6;">
                <strong>MySky</strong> is a social networking website offering an interactive,
                user-submitted network of friends, personal profiles, blogs, groups, photos,
                music and videos.
              </p>
              <p style="font-size: 12px; line-height: 1.6; margin-top: 10px;">
                Now powered by the <strong>AT Protocol</strong>, your data is truly yours.
                Take your friends, posts, and identity anywhere on the decentralized web.
              </p>
            </div>
          </div>
        </div>
      </div>
    )}
  </div>

  <Footer />
</Layout>

<script>
  import { Agent } from '@atproto/api';
  import { login, getSession } from '../lib/auth';
  import { getTopFriends, getProfiles, getBulletins } from '../lib/atproto';

  // Login form handler
  const form = document.getElementById('login-form') as HTMLFormElement;

  if (form) {
    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      const handleInput = document.getElementById('handle') as HTMLInputElement;
      const handle = handleInput.value.trim();

      if (!handle) return;

      try {
        await login(handle);
      } catch (error) {
        console.error('Login failed:', error);
        alert('Login failed. Please check your handle and try again.');
      }
    });
  }

  // Load friend space, bulletins, and cool new people for logged-in users
  const friendSpace = document.getElementById('friend-space');
  const coolPeople = document.getElementById('cool-people');
  const bulletinsPreview = document.getElementById('bulletins-preview');

  if (friendSpace || coolPeople || bulletinsPreview) {
    async function loadHomeData() {
      const session = await getSession();
      if (!session) return;

      const agent = new Agent(session);
      const userDid = agent.did || (session as any).did || (session as any).sub;

      // Load friend space (top friends)
      if (friendSpace) {
        try {
          const topFriends = await getTopFriends(agent, userDid);
          if (topFriends.length > 0) {
            const profiles = await getProfiles(agent, topFriends.slice(0, 8));
            friendSpace.innerHTML = `
              <div class="ms-top-friends">
                ${profiles.map(friend => `
                  <a href="/profile/${friend.handle}" class="ms-friend-card">
                    <img src="${friend.avatar || '/default-avatar.svg'}" alt="${friend.displayName || friend.handle}" class="ms-friend-pic" />
                    <span class="ms-friend-name">${friend.displayName || friend.handle}</span>
                  </a>
                `).join('')}
              </div>
            `;
          } else {
            friendSpace.innerHTML = '<p class="ms-text-gray ms-text-small">No top friends yet. <a href="/edit/friends">Add some friends!</a></p>';
          }
        } catch (error) {
          console.error('Failed to load friends:', error);
          friendSpace.innerHTML = '<p class="ms-text-gray ms-text-small">Could not load friends.</p>';
        }
      }

      // Load bulletins feed (yours + friends)
      if (bulletinsPreview) {
        try {
          const topFriends = await getTopFriends(agent, userDid);
          // Include yourself in the feed
          const allDids = [userDid, ...topFriends];
          const allProfiles = await getProfiles(agent, allDids);
          const profileMap = new Map(allProfiles.map(p => [p?.did, p]));

          const allBulletins: { bulletin: any; author: any }[] = [];

          for (const did of allDids) {
            try {
              const bulletins = await getBulletins(agent, did, 5);
              const author = profileMap.get(did);
              bulletins.forEach(b => allBulletins.push({ bulletin: b, author }));
            } catch {
              // Skip users with no bulletins
            }
          }

          // Sort by newest
          allBulletins.sort((a, b) =>
            new Date(b.bulletin.createdAt).getTime() - new Date(a.bulletin.createdAt).getTime()
          );

          if (allBulletins.length > 0) {
            bulletinsPreview.innerHTML = allBulletins.slice(0, 5).map(({ bulletin, author }) => `
              <div style="padding: 8px 0; border-bottom: 1px dotted #ccc;">
                <div style="font-size: 11px; color: #666;">
                  <a href="/profile/${author?.handle || ''}" style="font-weight: bold; color: var(--ms-link);">${author?.displayName || author?.handle || 'Unknown'}</a>
                  <span style="color: #999;"> - ${new Date(bulletin.createdAt).toLocaleDateString()}</span>
                </div>
                <div style="font-size: 12px; font-weight: bold; color: var(--ms-navy); margin: 4px 0;">${bulletin.subject}</div>
                <div style="font-size: 11px; color: #444;">${bulletin.body.substring(0, 100)}${bulletin.body.length > 100 ? '...' : ''}</div>
              </div>
            `).join('');
          } else {
            bulletinsPreview.innerHTML = '<p class="ms-text-gray ms-text-small">No bulletins yet. <a href="/bulletins">Post one!</a></p>';
          }
        } catch (error) {
          console.error('Failed to load bulletins:', error);
          bulletinsPreview.innerHTML = '<p class="ms-text-gray ms-text-small">Could not load bulletins.</p>';
        }
      }

      // Load cool new people (suggestions based on who you follow)
      if (coolPeople) {
        try {
          const following = await agent.getFollows({ actor: userDid, limit: 5 });

          if (following.data.follows.length === 0) {
            coolPeople.innerHTML = '<p class="ms-text-gray ms-text-small">Follow some people to get suggestions! <a href="/browse">Browse users</a></p>';
            return;
          }

          // Get followers of people you follow
          const suggestions: any[] = [];
          for (const follow of following.data.follows.slice(0, 3)) {
            try {
              const theirFollowers = await agent.getFollowers({ actor: follow.did, limit: 4 });
              suggestions.push(...theirFollowers.data.followers);
            } catch {
              continue;
            }
          }

          // Dedupe and exclude self
          const seen = new Set([userDid]);
          const uniqueSuggestions = suggestions.filter(s => {
            if (seen.has(s.did)) return false;
            seen.add(s.did);
            return true;
          }).slice(0, 6);

          if (uniqueSuggestions.length > 0) {
            coolPeople.innerHTML = `
              <div class="ms-top-friends">
                ${uniqueSuggestions.map(user => `
                  <a href="/profile/${user.handle}" class="ms-friend-card">
                    <img src="${user.avatar || '/default-avatar.svg'}" alt="${user.displayName || user.handle}" class="ms-friend-pic" />
                    <span class="ms-friend-name">${user.displayName || user.handle}</span>
                  </a>
                `).join('')}
              </div>
            `;
          } else {
            coolPeople.innerHTML = '<p class="ms-text-gray ms-text-small">No suggestions yet. <a href="/browse">Browse users</a></p>';
          }
        } catch (error) {
          console.error('Failed to load suggestions:', error);
          coolPeople.innerHTML = '<p class="ms-text-gray ms-text-small">Could not load suggestions.</p>';
        }
      }
    }

    loadHomeData();
  }
</script>

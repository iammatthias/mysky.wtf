---
import Layout from '../../layouts/Layout.astro';
import TopNav from '../../components/TopNav.astro';
import Footer from '../../components/Footer.astro';
import { MOODS } from '../../lib/lexicons';

const sessionCookie = Astro.cookies.get('ms_session');
let user = null;

if (sessionCookie) {
  try {
    user = JSON.parse(sessionCookie.value);
  } catch {
    // Invalid cookie
  }
}

if (!user) {
  return Astro.redirect('/login');
}
---

<Layout title="Edit Profile">
  <TopNav user={user} />

  <div class="ms-container">
    <div class="ms-profile">
      <div class="ms-profile-left">
        <div class="ms-box">
          <div class="ms-box-header">Edit Options</div>
          <div class="ms-actions">
            <a href="/edit" class="ms-action-btn ms-action-btn-primary">Profile Info</a>
            <a href="/edit/interests" class="ms-action-btn">Interests & Personality</a>
            <a href="/edit/friends" class="ms-action-btn">Manage Top Friends</a>
            <a href="/edit/photos" class="ms-action-btn">Photos</a>
            <a href="/edit/css" class="ms-action-btn">Customize CSS</a>
            <a href="/edit/song" class="ms-action-btn">Profile Song</a>
            <a href="/edit/privacy" class="ms-action-btn">Privacy Settings</a>
          </div>
        </div>

        <div class="ms-box">
          <div class="ms-box-header ms-box-header-blue">Preview</div>
          <div class="ms-box-content ms-text-center">
            <a href={`/profile/${user.handle}`} class="ms-action-btn">View My Profile</a>
          </div>
        </div>

        <div class="ms-ad">
          <div class="ms-ad-label">ADVERTISEMENT</div>
          <p>ðŸŽ¨ Want a UNIQUE profile?</p>
          <p class="ms-text-small">Get custom layouts now!</p>
        </div>
      </div>

      <div class="ms-profile-right">
        <div class="ms-box">
          <div class="ms-box-header">Edit Profile</div>
          <div class="ms-box-content">
            <form id="profile-form" class="ms-form">
              <div class="ms-section-header">Basic Info</div>

              <div class="ms-form-group">
                <label class="ms-form-label" for="headline">Headline / Tagline:</label>
                <input
                  type="text"
                  id="headline"
                  name="headline"
                  class="ms-form-input"
                  placeholder="What's your vibe?"
                  maxlength="100"
                />
                <p class="ms-text-small ms-text-gray" style="margin-top: 2px;">Shows under your name</p>
              </div>

              <div class="ms-form-group">
                <label class="ms-form-label" for="mood">Current Mood:</label>
                <select id="mood" name="mood" class="ms-form-select" style="width: 200px;">
                  <option value="">-- Select Mood --</option>
                  {MOODS.map(mood => (
                    <option value={mood}>{mood}</option>
                  ))}
                </select>
              </div>

              <div class="ms-section-header" style="margin-top: 20px;">About Me</div>

              <div class="ms-form-group">
                <label class="ms-form-label" for="aboutMe">About Me:</label>
                <textarea
                  id="aboutMe"
                  name="aboutMe"
                  class="ms-form-textarea"
                  placeholder="Tell people about yourself... your personality, what you're about, what makes you unique!"
                  style="min-height: 150px;"
                ></textarea>
              </div>

              <div class="ms-form-group">
                <label class="ms-form-label" for="whoIdLikeToMeet">Who I'd Like to Meet:</label>
                <textarea
                  id="whoIdLikeToMeet"
                  name="whoIdLikeToMeet"
                  class="ms-form-textarea"
                  placeholder="Describe the kind of people you'd like to connect with..."
                  style="min-height: 100px;"
                ></textarea>
              </div>

              <div class="ms-section-header" style="margin-top: 20px;">Interests</div>

              <div class="ms-form-group">
                <label class="ms-form-label" for="interest-general">General:</label>
                <input type="text" id="interest-general" name="interest-general" class="ms-form-input" placeholder="Your general interests..." />
              </div>

              <div class="ms-form-group">
                <label class="ms-form-label" for="interest-music">Music:</label>
                <input type="text" id="interest-music" name="interest-music" class="ms-form-input" placeholder="Favorite bands, genres, artists..." />
              </div>

              <div class="ms-form-group">
                <label class="ms-form-label" for="interest-movies">Movies:</label>
                <input type="text" id="interest-movies" name="interest-movies" class="ms-form-input" placeholder="Favorite films..." />
              </div>

              <div class="ms-form-group">
                <label class="ms-form-label" for="interest-television">Television:</label>
                <input type="text" id="interest-television" name="interest-television" class="ms-form-input" placeholder="Favorite TV shows..." />
              </div>

              <div class="ms-form-group">
                <label class="ms-form-label" for="interest-books">Books:</label>
                <input type="text" id="interest-books" name="interest-books" class="ms-form-input" placeholder="Favorite books, authors..." />
              </div>

              <div class="ms-form-group">
                <label class="ms-form-label" for="interest-heroes">Heroes:</label>
                <input type="text" id="interest-heroes" name="interest-heroes" class="ms-form-input" placeholder="People you admire..." />
              </div>

              <div style="margin-top: 20px; display: flex; gap: 10px;">
                <button type="submit" class="ms-form-submit" id="save-btn">Save All Changes</button>
                <a href={`/profile/${user.handle}`} class="ms-action-btn">Cancel</a>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

  <Footer />
</Layout>

<script>
  import { Agent } from '@atproto/api';
  import { getSession } from '../../lib/auth';
  import { getMySpaceProfile, saveMySpaceProfile } from '../../lib/atproto';

  async function loadProfile() {
    const session = await getSession();
    if (!session) {
      window.location.href = '/login';
      return;
    }

    const agent = new Agent(session);

    try {
      const profile = await getMySpaceProfile(agent, session.did);
      if (profile) {
        // Populate form fields
        (document.getElementById('headline') as HTMLInputElement).value = profile.headline || '';
        (document.getElementById('mood') as HTMLSelectElement).value = profile.mood || '';
        (document.getElementById('aboutMe') as HTMLTextAreaElement).value = profile.aboutMe || '';
        (document.getElementById('whoIdLikeToMeet') as HTMLTextAreaElement).value = profile.whoIdLikeToMeet || '';

        if (profile.interests) {
          (document.getElementById('interest-general') as HTMLInputElement).value = profile.interests.general || '';
          (document.getElementById('interest-music') as HTMLInputElement).value = profile.interests.music || '';
          (document.getElementById('interest-movies') as HTMLInputElement).value = profile.interests.movies || '';
          (document.getElementById('interest-television') as HTMLInputElement).value = profile.interests.television || '';
          (document.getElementById('interest-books') as HTMLInputElement).value = profile.interests.books || '';
          (document.getElementById('interest-heroes') as HTMLInputElement).value = profile.interests.heroes || '';
        }
      }
    } catch (e) {
      console.log('No existing profile found, starting fresh');
    }
  }

  loadProfile();

  const form = document.getElementById('profile-form') as HTMLFormElement;
  const saveBtn = document.getElementById('save-btn') as HTMLButtonElement;

  form.addEventListener('submit', async (e) => {
    e.preventDefault();

    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';

    try {
      const session = await getSession();
      if (!session) {
        window.location.href = '/login';
        return;
      }

      const agent = new Agent(session);

      const profileData = {
        headline: (document.getElementById('headline') as HTMLInputElement).value.trim() || undefined,
        mood: (document.getElementById('mood') as HTMLSelectElement).value || undefined,
        aboutMe: (document.getElementById('aboutMe') as HTMLTextAreaElement).value.trim() || undefined,
        whoIdLikeToMeet: (document.getElementById('whoIdLikeToMeet') as HTMLTextAreaElement).value.trim() || undefined,
        interests: {
          general: (document.getElementById('interest-general') as HTMLInputElement).value.trim() || undefined,
          music: (document.getElementById('interest-music') as HTMLInputElement).value.trim() || undefined,
          movies: (document.getElementById('interest-movies') as HTMLInputElement).value.trim() || undefined,
          television: (document.getElementById('interest-television') as HTMLInputElement).value.trim() || undefined,
          books: (document.getElementById('interest-books') as HTMLInputElement).value.trim() || undefined,
          heroes: (document.getElementById('interest-heroes') as HTMLInputElement).value.trim() || undefined,
        },
      };

      await saveMySpaceProfile(agent, profileData);

      alert('Profile saved successfully!');
      saveBtn.textContent = 'Saved!';

      setTimeout(() => {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save All Changes';
      }, 2000);

    } catch (error) {
      console.error('Failed to save profile:', error);
      alert('Failed to save profile. Please try again.');
      saveBtn.disabled = false;
      saveBtn.textContent = 'Save All Changes';
    }
  });
</script>

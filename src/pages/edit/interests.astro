---
import Layout from '../../layouts/Layout.astro';
import TopNav from '../../components/TopNav.astro';
import Footer from '../../components/Footer.astro';

const sessionCookie = Astro.cookies.get('ms_session');
let user = null;
if (sessionCookie) {
  try { user = JSON.parse(sessionCookie.value); } catch {}
}

// Redirect to login if not authenticated
if (!user) {
  return Astro.redirect('/login?redirect=/edit/interests');
}
---

<Layout title="Edit Interests">
  <TopNav user={user} />
  <div class="ms-container">
    <div class="ms-box" style="max-width: 800px; margin: 0 auto;">
      <div class="ms-box-header">My Interests</div>
      <div class="ms-box-content">
        <div class="edit-nav">
          <a href="/edit">Profile</a>
          <a href="/edit/photos">Photos</a>
          <a href="/edit/song">Profile Song</a>
          <a href="/edit/interests" class="active">Interests</a>
          <a href="/edit/friends">Top Friends</a>
          <a href="/edit/css">Custom CSS</a>
        </div>

        <p style="font-size: 12px; color: #666; margin-bottom: 20px;">
          Tell the world what you're into! These will appear in the Interests section of your profile.
        </p>

        <form id="interestsForm">
          <div class="interest-section">
            <label for="general">General Interests</label>
            <textarea id="general" rows="3" placeholder="Reading, hiking, coffee, video games, etc."></textarea>
          </div>

          <div class="interest-section">
            <label for="music">Music</label>
            <textarea id="music" rows="3" placeholder="What bands, artists, or genres do you love?"></textarea>
          </div>

          <div class="interest-section">
            <label for="movies">Movies</label>
            <textarea id="movies" rows="3" placeholder="Your favorite films, directors, or genres"></textarea>
          </div>

          <div class="interest-section">
            <label for="television">Television</label>
            <textarea id="television" rows="3" placeholder="Shows you're watching or classics you love"></textarea>
          </div>

          <div class="interest-section">
            <label for="books">Books</label>
            <textarea id="books" rows="3" placeholder="What are you reading? Favorite authors?"></textarea>
          </div>

          <div class="interest-section">
            <label for="heroes">Heroes</label>
            <textarea id="heroes" rows="3" placeholder="People who inspire you"></textarea>
          </div>

          <div class="save-notice">
            <strong>Note:</strong> Your interests will be saved to your AT Protocol PDS using the
            <code>space.myspace.profile</code> lexicon. This feature is being finalized!
          </div>

          <div class="form-actions">
            <a href="/edit" class="ms-button-secondary">‚Üê Back to Edit Profile</a>
            <button type="submit" class="ms-button" id="saveBtn">Save Interests</button>
          </div>
        </form>
      </div>
    </div>
  </div>
  <Footer />
</Layout>

<script>
  import { getOAuthClient } from '../../lib/auth';
  import { Agent } from '@atproto/api';

  const form = document.getElementById('interestsForm') as HTMLFormElement;
  const saveBtn = document.getElementById('saveBtn') as HTMLButtonElement;

  // Load existing interests
  async function loadInterests() {
    try {
      const client = await getOAuthClient();
      const result = await client.init();

      if (result?.session) {
        const agent = new Agent(result.session);

        try {
          const response = await agent.com.atproto.repo.getRecord({
            repo: result.session.did,
            collection: 'space.myspace.profile',
            rkey: 'self',
          });

          const record = response.data.value as any;
          if (record.interests) {
            (document.getElementById('general') as HTMLTextAreaElement).value = record.interests.general || '';
            (document.getElementById('music') as HTMLTextAreaElement).value = record.interests.music || '';
            (document.getElementById('movies') as HTMLTextAreaElement).value = record.interests.movies || '';
            (document.getElementById('television') as HTMLTextAreaElement).value = record.interests.television || '';
            (document.getElementById('books') as HTMLTextAreaElement).value = record.interests.books || '';
            (document.getElementById('heroes') as HTMLTextAreaElement).value = record.interests.heroes || '';
          }
        } catch {
          // No existing record
        }
      }
    } catch (error) {
      console.error('Failed to load interests:', error);
    }
  }

  // Save interests
  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    saveBtn.disabled = true;
    saveBtn.textContent = 'Saving...';

    try {
      const client = await getOAuthClient();
      const result = await client.init();

      if (!result?.session) {
        alert('Please sign in to save your interests');
        return;
      }

      const agent = new Agent(result.session);

      const interests = {
        general: (document.getElementById('general') as HTMLTextAreaElement).value,
        music: (document.getElementById('music') as HTMLTextAreaElement).value,
        movies: (document.getElementById('movies') as HTMLTextAreaElement).value,
        television: (document.getElementById('television') as HTMLTextAreaElement).value,
        books: (document.getElementById('books') as HTMLTextAreaElement).value,
        heroes: (document.getElementById('heroes') as HTMLTextAreaElement).value,
      };

      // Try to get existing record first
      let existingRecord: any = null;
      try {
        const response = await agent.com.atproto.repo.getRecord({
          repo: result.session.did,
          collection: 'space.myspace.profile',
          rkey: 'self',
        });
        existingRecord = response.data;
      } catch {
        // No existing record
      }

      const record = {
        $type: 'space.myspace.profile',
        ...(existingRecord?.value || {}),
        interests,
        updatedAt: new Date().toISOString(),
      };

      await agent.com.atproto.repo.putRecord({
        repo: result.session.did,
        collection: 'space.myspace.profile',
        rkey: 'self',
        record,
      });

      alert('Interests saved successfully!');
    } catch (error) {
      console.error('Failed to save interests:', error);
      alert('Failed to save interests. Please try again.');
    } finally {
      saveBtn.disabled = false;
      saveBtn.textContent = 'Save Interests';
    }
  });

  // Load on page load
  loadInterests();
</script>

<style>
  .edit-nav {
    display: flex;
    gap: 5px;
    flex-wrap: wrap;
    padding: 10px;
    background: var(--ms-blue-light);
    border-radius: 4px;
    margin-bottom: 20px;
  }

  .edit-nav a {
    padding: 6px 12px;
    font-size: 11px;
    text-decoration: none;
    color: var(--ms-navy);
    background: white;
    border-radius: 3px;
    border: 1px solid #ccc;
  }

  .edit-nav a:hover {
    background: #f0f0f0;
  }

  .edit-nav a.active {
    background: var(--ms-orange);
    color: white;
    border-color: #d45500;
  }

  .interest-section {
    margin-bottom: 20px;
  }

  .interest-section label {
    display: block;
    font-size: 12px;
    font-weight: bold;
    color: var(--ms-navy);
    margin-bottom: 5px;
  }

  .interest-section textarea {
    width: 100%;
    padding: 10px;
    font-size: 12px;
    font-family: inherit;
    border: 1px solid #ccc;
    border-radius: 4px;
    resize: vertical;
    box-sizing: border-box;
  }

  .interest-section textarea:focus {
    outline: none;
    border-color: var(--ms-orange);
    box-shadow: 0 0 3px rgba(255, 102, 0, 0.3);
  }

  .save-notice {
    background: var(--ms-blue-light);
    border-radius: 4px;
    padding: 12px;
    font-size: 11px;
    color: var(--ms-navy);
    margin-top: 20px;
  }

  .save-notice code {
    background: white;
    padding: 2px 5px;
    border-radius: 3px;
    font-size: 10px;
  }

  .form-actions {
    display: flex;
    justify-content: space-between;
    margin-top: 25px;
    padding-top: 20px;
    border-top: 1px solid #ddd;
  }

  .ms-button {
    display: inline-block;
    padding: 8px 20px;
    background: var(--ms-orange);
    color: white;
    text-decoration: none;
    border-radius: 4px;
    font-size: 12px;
    border: 1px solid #d45500;
    cursor: pointer;
  }

  .ms-button:disabled {
    opacity: 0.6;
    cursor: not-allowed;
  }

  .ms-button-secondary {
    display: inline-block;
    padding: 8px 20px;
    background: white;
    color: var(--ms-navy);
    text-decoration: none;
    border-radius: 4px;
    font-size: 12px;
    border: 1px solid #ccc;
  }

  .ms-button:hover:not(:disabled),
  .ms-button-secondary:hover {
    opacity: 0.9;
  }
</style>

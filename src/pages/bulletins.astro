---
import Layout from "../layouts/Layout.astro";
import TopNav from "../components/TopNav.astro";
import Footer from "../components/Footer.astro";

const sessionCookie = Astro.cookies.get("ms_session");
let user = null;
if (sessionCookie) {
    try {
        user = JSON.parse(sessionCookie.value);
    } catch {}
}

if (!user) {
    return Astro.redirect("/login?redirect=/bulletins");
}
---

<Layout title="Bulletins">
    <TopNav user={user} />
    <div class="ms-container">
        <div class="bulletins-layout">
            <div class="bulletins-sidebar">
                <div class="ms-box">
                    <div class="ms-box-header">Bulletin Board</div>
                    <div class="ms-actions">
                        <button
                            class="ms-action-btn ms-action-btn-primary"
                            id="post-bulletin-btn">Post Bulletin</button
                        >
                        <a href="/" class="ms-action-btn">Back to Home</a>
                    </div>
                </div>

                <div class="ms-box">
                    <div class="ms-box-header ms-box-header-blue">My Stats</div>
                    <div class="ms-box-content">
                        <table class="ms-contact-table">
                            <tr>
                                <td>Posted:</td>
                                <td id="posted-count">0</td>
                            </tr>
                            <tr>
                                <td>Friends:</td>
                                <td id="friends-count">0</td>
                            </tr>
                        </table>
                    </div>
                </div>

                <div class="ms-ad">
                    <div class="ms-ad-label">ADVERTISEMENT</div>
                    <p>Get MORE friends!</p>
                    <p class="ms-text-small">Browse profiles now</p>
                </div>
            </div>

            <div class="bulletins-main">
                <div class="ms-box" id="post-form-box" style="display: none;">
                    <div class="ms-box-header">Post a Bulletin</div>
                    <div class="ms-box-content">
                        <form id="bulletin-form" class="ms-form">
                            <div class="ms-form-group">
                                <label
                                    class="ms-form-label"
                                    for="bulletin-subject">Subject:</label
                                >
                                <input
                                    type="text"
                                    id="bulletin-subject"
                                    name="subject"
                                    class="ms-form-input"
                                    placeholder="What's this about?"
                                    maxlength="100"
                                    required
                                />
                            </div>
                            <div class="ms-form-group">
                                <label class="ms-form-label" for="bulletin-body"
                                    >Body:</label
                                >
                                <textarea
                                    id="bulletin-body"
                                    name="body"
                                    class="ms-form-textarea"
                                    placeholder="Write your bulletin here... All your friends will see this!"
                                    style="min-height: 120px;"
                                    required></textarea>
                            </div>
                            <div style="display: flex; gap: 10px;">
                                <button
                                    type="submit"
                                    class="ms-form-submit"
                                    id="submit-btn">Post Bulletin</button
                                >
                                <button
                                    type="button"
                                    class="ms-action-btn"
                                    id="cancel-btn">Cancel</button
                                >
                            </div>
                        </form>
                    </div>
                </div>

                <div class="ms-box">
                    <div class="ms-box-header">Friend Bulletins</div>
                    <div class="ms-box-content" id="bulletins-list">
                        <div class="ms-loading">
                            <div class="ms-spinner"></div>
                        </div>
                    </div>
                </div>

                <div class="ms-box">
                    <div class="ms-box-header ms-box-header-blue">
                        My Bulletins
                    </div>
                    <div class="ms-box-content" id="my-bulletins-list">
                        <div class="ms-loading">
                            <div class="ms-spinner"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <Footer />
</Layout>

<style is:global>
    .bulletins-layout {
        display: grid;
        grid-template-columns: 200px 1fr;
        gap: 15px;
        max-width: 900px;
        margin: 0 auto;
    }

    .bulletins-sidebar {
        min-width: 0;
    }

    .bulletins-main {
        min-width: 0;
    }

    .bulletin-item {
        padding: 12px;
        border-bottom: 1px solid #eee;
    }

    .bulletin-item:last-child {
        border-bottom: none;
    }

    .bulletin-item:hover {
        background: #fafafa;
    }

    .bulletin-header {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 8px;
    }

    .bulletin-author {
        display: flex;
        align-items: center;
        gap: 10px;
    }

    .bulletin-avatar {
        width: 36px;
        height: 36px;
        border-radius: 4px;
        object-fit: cover;
        border: 1px solid #ddd;
    }

    .bulletin-author-info {
        display: flex;
        flex-direction: column;
    }

    .bulletin-author-name {
        font-size: 12px;
        font-weight: bold;
        color: var(--ms-navy);
    }

    .bulletin-author-name a {
        color: var(--ms-link);
        text-decoration: none;
    }

    .bulletin-author-name a:hover {
        text-decoration: underline;
    }

    .bulletin-time {
        font-size: 10px;
        color: #999;
    }

    .bulletin-new {
        font-size: 9px;
        background: var(--ms-orange);
        color: white;
        padding: 2px 6px;
        border-radius: 3px;
        font-weight: bold;
    }

    .bulletin-subject {
        font-size: 13px;
        font-weight: bold;
        color: var(--ms-navy);
        margin-bottom: 6px;
    }

    .bulletin-body {
        font-size: 12px;
        line-height: 1.5;
        color: #444;
        max-height: 100px;
        overflow: hidden;
        position: relative;
    }

    .bulletin-body.expanded {
        max-height: none;
    }

    .bulletin-body.truncated::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 30px;
        background: linear-gradient(transparent, white);
    }

    .bulletin-expand {
        font-size: 11px;
        color: var(--ms-link);
        cursor: pointer;
        margin-top: 5px;
        display: none;
    }

    .bulletin-expand:hover {
        color: var(--ms-orange);
    }

    .bulletin-body.truncated + .bulletin-expand {
        display: inline-block;
    }

    .empty-bulletins {
        text-align: center;
        padding: 30px 20px;
    }

    .empty-bulletins-icon {
        font-size: 36px;
        margin-bottom: 10px;
    }

    .empty-bulletins p {
        font-size: 12px;
        color: #666;
        margin: 5px 0;
    }

    .ms-contact-table {
        width: 100%;
        font-size: 11px;
    }

    .ms-contact-table td {
        padding: 4px 0;
    }

    .ms-contact-table td:first-child {
        color: #666;
        width: 60px;
    }

    .ms-contact-table td:last-child {
        font-weight: bold;
        color: var(--ms-navy);
    }

    @media (max-width: 768px) {
        .bulletins-layout {
            grid-template-columns: 1fr;
        }

        .bulletins-sidebar {
            display: none;
        }
    }
</style>

<script>
    import { Agent } from "@atproto/api";
    import { getSession } from "../lib/auth";
    import {
        postBulletin,
        getBulletins,
        getTopFriends,
        getProfiles,
    } from "../lib/atproto";

    const postBtn = document.getElementById("post-bulletin-btn");
    const cancelBtn = document.getElementById("cancel-btn");
    const formBox = document.getElementById("post-form-box");
    const bulletinsList = document.getElementById("bulletins-list")!;
    const myBulletinsList = document.getElementById("my-bulletins-list")!;
    const postedCount = document.getElementById("posted-count")!;
    const friendsCount = document.getElementById("friends-count")!;

    postBtn?.addEventListener("click", () => {
        formBox!.style.display = "block";
        formBox!.scrollIntoView({ behavior: "smooth" });
    });

    cancelBtn?.addEventListener("click", () => {
        formBox!.style.display = "none";
    });

    // Escape HTML to prevent XSS
    function escapeHtml(text: string): string {
        const div = document.createElement("div");
        div.textContent = text;
        return div.innerHTML;
    }

    // Check if bulletin is new (less than 24 hours old)
    function isNew(createdAt: string): boolean {
        const created = new Date(createdAt).getTime();
        const now = Date.now();
        return now - created < 24 * 60 * 60 * 1000;
    }

    // Render a bulletin item
    function renderBulletin(bulletin: any, author?: any, index?: number) {
        const authorName = author?.displayName || author?.handle || "Unknown";
        const authorHandle = author?.handle || "";
        const avatar = author?.avatar || "/default-avatar.svg";
        const newBadge = isNew(bulletin.createdAt)
            ? '<span class="bulletin-new">NEW</span>'
            : "";
        const bulletinId = `bulletin-${index || Math.random().toString(36).substring(7)}`;

        return `
      <div class="bulletin-item">
        <div class="bulletin-header">
          <div class="bulletin-author">
            <img src="${escapeHtml(avatar)}" alt="${escapeHtml(authorName)}" class="bulletin-avatar" />
            <div class="bulletin-author-info">
              <span class="bulletin-author-name">
                <a href="/profile/${escapeHtml(authorHandle)}">${escapeHtml(authorName)}</a>
              </span>
              <span class="bulletin-time">${new Date(bulletin.createdAt).toLocaleString()}</span>
            </div>
          </div>
          ${newBadge}
        </div>
        <div class="bulletin-subject">${escapeHtml(bulletin.subject)}</div>
        <div class="bulletin-body" id="${bulletinId}">${escapeHtml(bulletin.body).replace(/\n/g, "<br>")}</div>
        <span class="bulletin-expand" data-target="${bulletinId}">Read more...</span>
      </div>
    `;
    }

    // Setup expand/collapse handlers
    function setupExpandHandlers() {
        document.querySelectorAll(".bulletin-body").forEach((body) => {
            const el = body as HTMLElement;
            // Check if content is truncated
            if (el.scrollHeight > el.clientHeight + 10) {
                el.classList.add("truncated");
            }
        });

        document.querySelectorAll(".bulletin-expand").forEach((btn) => {
            btn.addEventListener("click", () => {
                const targetId = (btn as HTMLElement).dataset.target;
                if (targetId) {
                    const body = document.getElementById(targetId);
                    if (body) {
                        body.classList.toggle("expanded");
                        body.classList.remove("truncated");
                        (btn as HTMLElement).textContent =
                            body.classList.contains("expanded")
                                ? "Show less"
                                : "Read more...";
                        if (!body.classList.contains("expanded")) {
                            if (body.scrollHeight > body.clientHeight + 10) {
                                body.classList.add("truncated");
                            }
                        }
                    }
                }
            });
        });
    }

    async function loadBulletins() {
        const session = await getSession();
        if (!session) {
            window.location.href = "/login";
            return;
        }

        const agent = new Agent(session);
        const userDid =
            agent.did || (session as any).did || (session as any).sub;
        console.log(
            "Bulletins - userDid:",
            userDid,
            "agent.did:",
            agent.did,
            "session:",
            session,
        );

        try {
            // Load my bulletins
            const myBulletins = await getBulletins(agent, userDid, 20);
            postedCount.textContent = myBulletins.length.toString();

            if (myBulletins.length === 0) {
                myBulletinsList.innerHTML = `
          <p class="ms-text-gray ms-text-small" style="padding: 15px; text-align: center;">
            You haven't posted any bulletins yet.
          </p>
        `;
            } else {
                // Sort by most recent
                myBulletins.sort(
                    (a, b) =>
                        new Date(b.createdAt).getTime() -
                        new Date(a.createdAt).getTime(),
                );

                const profile = await agent.getProfile({ actor: userDid });
                myBulletinsList.innerHTML = myBulletins
                    .slice(0, 5)
                    .map((b, i) => renderBulletin(b, profile.data, i + 1000))
                    .join("");
            }

            // Load friends' bulletins
            const friendDids = await getTopFriends(agent, userDid);
            friendsCount.textContent = friendDids.length.toString();

            if (friendDids.length === 0) {
                bulletinsList.innerHTML = `
          <div class="empty-bulletins">
            <div class="empty-bulletins-icon">ðŸ“‹</div>
            <p>No friends yet!</p>
            <p style="font-size: 11px; color: #999;">
              Add friends to see their bulletins here.
            </p>
          </div>
        `;
                setupExpandHandlers();
                return;
            }

            // Get profiles for all friends
            const profiles = await getProfiles(agent, friendDids);
            const profileMap = new Map(profiles.map((p) => [p?.did, p]));

            // Get bulletins from all friends
            const allFriendBulletins: { bulletin: any; author: any }[] = [];

            for (const did of friendDids) {
                try {
                    const friendBulletins = await getBulletins(agent, did, 10);
                    const author = profileMap.get(did);
                    friendBulletins.forEach((b) =>
                        allFriendBulletins.push({ bulletin: b, author }),
                    );
                } catch (e) {
                    // Skip friends with no bulletins
                }
            }

            if (allFriendBulletins.length === 0) {
                bulletinsList.innerHTML = `
          <div class="empty-bulletins">
            <div class="empty-bulletins-icon">ðŸ“‹</div>
            <p>No bulletins from your friends yet!</p>
            <p style="font-size: 11px; color: #999;">
              Bulletins from people in your Top Friends will appear here.
            </p>
          </div>
        `;
                setupExpandHandlers();
                return;
            }

            // Sort by most recent
            allFriendBulletins.sort(
                (a, b) =>
                    new Date(b.bulletin.createdAt).getTime() -
                    new Date(a.bulletin.createdAt).getTime(),
            );

            bulletinsList.innerHTML = allFriendBulletins
                .slice(0, 20)
                .map(({ bulletin, author }, i) =>
                    renderBulletin(bulletin, author, i),
                )
                .join("");

            setupExpandHandlers();
        } catch (error) {
            console.error("Failed to load bulletins:", error);
            bulletinsList.innerHTML = `
        <div class="empty-bulletins">
          <div class="empty-bulletins-icon">ðŸ“‹</div>
          <p>No bulletins from your friends yet!</p>
          <p style="font-size: 11px; color: #999;">
            Bulletins from people in your Top Friends will appear here.
          </p>
        </div>
      `;
            myBulletinsList.innerHTML = `
        <p class="ms-text-gray ms-text-small" style="padding: 15px; text-align: center;">
          You haven't posted any bulletins yet.
        </p>
      `;
        }
    }

    loadBulletins();

    // Handle form submission
    const form = document.getElementById("bulletin-form") as HTMLFormElement;
    const submitBtn = document.getElementById(
        "submit-btn",
    ) as HTMLButtonElement;

    form?.addEventListener("submit", async (e) => {
        e.preventDefault();

        submitBtn.disabled = true;
        submitBtn.textContent = "Posting...";

        const subject = (
            document.getElementById("bulletin-subject") as HTMLInputElement
        ).value.trim();
        const body = (
            document.getElementById("bulletin-body") as HTMLTextAreaElement
        ).value.trim();

        if (!subject || !body) {
            alert("Please fill in both subject and body!");
            submitBtn.disabled = false;
            submitBtn.textContent = "Post Bulletin";
            return;
        }

        try {
            const session = await getSession();
            if (!session) {
                window.location.href = "/login";
                return;
            }

            const agent = new Agent(session);
            await postBulletin(agent, subject, body);

            form.reset();
            formBox!.style.display = "none";

            // Reload bulletins to show the new one
            await loadBulletins();
        } catch (error) {
            console.error("Failed to post bulletin:", error);
            alert("Failed to post bulletin. Please try again.");
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = "Post Bulletin";
        }
    });
</script>
